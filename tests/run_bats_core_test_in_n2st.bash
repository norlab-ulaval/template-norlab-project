#!/bin/bash
# =================================================================================================
# Execute 'template-norlab-project' repo shell script tests via 'norlab-shell-script-tools' library
#
# Usage:
#   $ bash run_bats_core_test_in_n2st.bash ['<test-directory>[/<this-bats-test-file.bats>]' ['<image-distro>']]
#
# Positional argument:
#   '<test-directory>'                The directory from which to start test (default to 'tests')
#   '<bats-test-file-name.bats>'      A specific bats file to run, default will run all bats file
#                                      in the test directory
#   '<image-distro>'                  ubuntu or alpine (default ubuntu)
#
# Globals:
#   Read PROJECT_PATH                  Path to TNP root
#   Read N2ST_PATH                     Default to "utilities/norlab-shell-script-tools"
#
# =================================================================================================
params=( "$@" )

if [[ -z ${params[0]} ]]; then
  # Set to default bats tests directory if none specified
  params="tests/tests_bats/"
fi

function tnp::run_n2st_testing_tools(){

  # ....Project root logic.........................................................................
  local tnp_root
  tnp_root=$(git rev-parse --show-toplevel)

  # ....Load environment variables from file.......................................................
  cd "${tnp_root}" || exit 1
  set -o allexport
  source .env.template-norlab-project.template
  set +o allexport

  export TNP_PATH=${PROJECT_PATH:?err}
  TNP_GIT_CURRENT_BRANCH=$(git symbolic-ref -q --short HEAD || git describe --all --exact-match)

  if [[ ${TEAMCITY_VERSION} ]] ; then
    TNP_TEAMCITY_PR_SOURCE=${TNP_TEAMCITY_PR_SOURCE:?'Variable must be set manually by TC run configuration using
TNP_TEAMCITY_PR_SOURCE=%teamcity.pullRequest.source.branch%
export TNP_TEAMCITY_PR_SOURCE
'}
  fi

  ( \
    echo "# ... Automatically generated by run_bats_core_test_in_n2st.bash ..."; \
    echo "TNP_PATH=${PROJECT_PATH}"; \
    echo "TNP_GIT_REMOTE_URL=${PROJECT_GIT_REMOTE_URL}"; \
    echo "TNP_GIT_NAME=${PROJECT_GIT_NAME}"; \
    echo "TNP_GIT_CURRENT_BRANCH=${TNP_GIT_CURRENT_BRANCH}"; \
    echo "TNP_TEAMCITY_PR_SOURCE=${TNP_TEAMCITY_PR_SOURCE}"; \
    echo ""; \
  ) > "${TNP_PATH}/tests/.env.tnp_test_values"

  # ....Setup........................................................................................
  bash "${TNP_PATH:?err}/tests/setup_mock.bash" || return 1

  function tnp::bats_tests_teardown_callback() {
    exit_code=$?
    cd "${TNP_PATH:?err}" || exit 1
    bash tests/teardown_mock.bash
    exit ${exit_code:1}
  }
  trap tnp::bats_tests_teardown_callback EXIT

  # ....Execute N2ST run_bats_tests_in_docker.bash.................................................
  # shellcheck disable=SC2086
  bash "${N2ST_PATH:?err}/tests/bats_testing_tools/run_bats_tests_in_docker.bash" "${params[@]}"

  # ....Teardown...................................................................................
  # Handle by the trap command
  }

tnp::run_n2st_testing_tools
